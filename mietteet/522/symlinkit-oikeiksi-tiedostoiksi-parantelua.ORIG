<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />


        <!-- standard -->
	<title>Mr. P: Symlinkit oikeiksi tiedostoiksi: parantelua</title>


	<link rel="home" href="../../index.html" />

	<link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="../../atom/index.html?section=mietteet" />
	<link rel="alternate" type="application/rss+xml" title="RSS 0.92" href="../../rss/index.html?section=mietteet" />

	<link rel="stylesheet" type="text/css" media="screen" href="../../blog.css" />
        <link rel="stylesheet" type="text/css" href="../../codeblock.css" />

            <!-- SyntaxHighlighter: http://alexgorbatchev.com -->
    <script type="text/javascript" src="../../scripts/xregexp-min.js"></script>
    <script type="text/javascript" src="../../scripts/shCore.js"></script>
    <!-- langs -->
    <script type="text/javascript" src="../../scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushPerl.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushClojure.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushHaskell.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushVimscript.js"></script>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../rpc/index.html" />
</head>

<body id="mietteet">

<!-- accessibility -->
<div id="accessibility">
    <ul>
        <li><a href="symlinkit-oikeiksi-tiedostoiksi-parantelua#content">Siirry sisältöön</a></li>
        <li><a href="symlinkit-oikeiksi-tiedostoiksi-parantelua#sidebar-2">Siirry hakuun</a></li>
    </ul>
</div>

<div id="container">

<!-- head -->
    <div id="head">
        <h1 id="site-name"><a rel="home" href="../../index.html">Mr. P</a></h1>
        <p id="site-slogan">Asiaa porjoilun tuolta puolen</p>
    </div>

<!-- right -->
    <div id="sidebar-2">
        <ul class="section_list">
	<li>
            
            <a href="../../hetket/index.html">Hetkessä</a>
            
        </li>
	<li>
            
            <a href="../../matematiikka/index.html">Matematiikka</a>
            
        </li>
	<li>
            &raquo;
            <a href="../index.html">Mietteet</a>
            
                <!--<ul>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/598/blogille-idea">Blogille&#160;idea</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/597/wes-mckinney-python-for-data-analysis-oreilly">Wes McKinney - Python For Data Analysis (O&#39;Reilly)</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/596/org-blogaaminen-vaikeata">Org-blogaaminen&#160;vaikeata</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/595/twitterointia-emacsilla">Twitteröintiä&#160;Emacsilla</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/594/weboodi-aikataulut-orgiin">WebOodi-aikataulut&#160;orgiin</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/593/emacsin-salat-alkavat-selvita-org-kovenee-ja-muita-tarinoita">Emacsin salat alkavat selvitä; org kovenee ja muita&#160;tarinoita</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/592/emacs-has-me">Emacs has&#160;me.</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/591/editorien-taistelu-tietamyshallinnassa">Editorien taistelu&#160;tietämyshallinnassa</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/590/think-vimorganizer">Think&#160;VimOrganizer.</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="http://progo.viuhka.fi/mietteet/589/think-orgmode">Think&#160;orgmode.</a>
                </li>
</ul>-->
            
        </li>
</ul>
<!--        <p class="sidebarhead">Aiheita:</p>
        <ul class="category_list">
	<li><a href="http://progo.viuhka.fi/kategoria/hifi/">Hifi</a></li>
	<li><a href="http://progo.viuhka.fi/kategoria/koodaus/">Ohjelmointi</a></li>
	<li><a href="http://progo.viuhka.fi/kategoria/ohjelmistot/">Ohjelmistot</a></li>
	<li><a href="http://progo.viuhka.fi/kategoria/Opiskelu/">Opiskelu</a></li>
	<li><a href="http://progo.viuhka.fi/kategoria/rauta/">Rauta</a></li>
	<li><a href="http://progo.viuhka.fi/kategoria/viihde/">Viihde</a></li>
	<li><a href="http://progo.viuhka.fi/kategoria/Yleistae-turinaa/">Yleistä turinaa</a></li>
</ul> -->

        <p class="sidebarhead">Valikoituja aiheita:</p>
        <ul class="category_list">
	<li><a href="../../tag/amarok/index.html" class="tagSizeSmallest tagSize1" style="font-size: 100%;">amarok</a></li>
	<li><a href="../../tag/blogisäätöä/index.html" class="tagSizeMedium tagSize31" style="font-size: 100%;">blogisäätöä</a></li>
	<li><a href="../../tag/gentoo/index.html" class="tagSizeLargest tagSize111" style="font-size: 100%;">gentoo</a></li>
	<li><a href="../../tag/hifi/index.html" class="tagSizeMedium tagSize37" style="font-size: 100%;">hifi</a></li>
	<li><a href="../../tag/musiikki/index.html" class="tagSizeMedium tagSize29" style="font-size: 100%;">musiikki</a></li>
	<li><a href="../../tag/ohjelmointi/index.html" class="tagSizeMedium tagSize48" style="font-size: 100%;">ohjelmointi</a></li>
	<li><a href="../../tag/opiskelu/index.html" class="tagSizeMedium tagSize23" style="font-size: 100%;">opiskelu</a></li>
	<li><a href="../../tag/skriptaus/index.html" class="tagSizeMedium tagSize7" style="font-size: 100%;">skriptaus</a></li>
</ul>
        <p><a href="../../tag/index.html">Kaikki tagit</a></p>

        <form method="get" action="../../index.html">
<p class="search_input">Hae<br /><input type="text" value="" name="q" size="15" /></p>
</form>

        <p><a href="../../rss/index.html?section=mietteet" title="RSS 0.92">RSS</a> / <a href="../../atom/index.html?section=mietteet" title="Atom 1.0">Atom</a></p>
        <p class="linklist"><a href="http://textpattern.net/">TextBook</a><br /><a href="http://textpattern.com/">Textpattern</a><br /><a href="http://textpattern.org/">Txp Resources</a><br /><a href="http://twitter.com/progo_" title="Twitter-profiilini">Twitter</a><br /></p>

        <p><a href="http://textpattern.com/"><img src="../../images/2.png" alt="Textpattern CMS" width="105" height="45" /></a></p>
    </div>


<!-- center -->
    <div id="content">



<!-- not tag view, it's the main view -->


        

        <div class="hfeed">
            <!-- five articles to list here, or only one. It depends. -->
            <!-- default form -->

<p class="published"> 3. huhtikuu 2011, 10:42</p>
<h1 class="entry-title"><a rel="bookmark" href="symlinkit-oikeiksi-tiedostoiksi-parantelua">Symlinkit oikeiksi tiedostoiksi:&#160;parantelua</a></h1>


<div class="entry-content">
	<p><a href="../519/symlinkit-oikeiksi-tiedostoiksi">Edellisessä</a> jutussa hahmottelin alustavan rakennelman. Tällä kertaa se pitää parantaa loppuunsa lisäämällä argumentteja ja argumenttien hallintaa skriptiin. Kryptiset <code>getopt</code>-koodit aukesivat kahvin ja kokeilujen kanssa.</p>

	<p>Minun tarvitsee tehdä vain hyvin pieniä muutoksia edelliseen versioon nähden, sillä sain haluamani toiminnallisuuden kasaan esimerkeistä. Yleinen getopt-runko ohjelmalle, joka käsittelee mielivaltaisen määrän tiedostoja:</p>

<pre class="bash">#!/bin/bash
while getopts &quot;:flags&quot; flag
do
    echo &quot;$flag&quot; $OPTIND $OPTARG
done

# after shift, $@ contains the unhandled arguments. Files etc
shift $((OPTIND-1))

for rest in &quot;$@&quot;; do
    echo $rest
done
</pre>

	<p>Taikasana on <code>shift</code>! Nyt jos vertaatte edellisen kirjoituksen runkoon, niin sama for-silmukka on se sielläkin. Ei muutoksia. Kokeilin tietenkin kattavasti ohjelman toimintaa noilla echo-lauseilla sun muulla. Enhän haluaisi symlink-ohjelmani aiheuttavan tietojenkadottamista.</p>

	<h2>Symlinkit siirtäen</h2>

	<p>Pari asetusta on mielessä: yksi on tietenkin mahdollisuus käyttää siirtämistä kopioinnin sijaan. Toinen ajatus on kokeiluajo. Näillähän saa jo evästä getoptille. Ensimmäinen vaihe olisi kai siirtää kovakoodaukset muuttujien taakse. Siispä ohjelman ydinosa muuttuu seuraavalla tavalla tekemällä muuttujansijoitukset:</p>

<pre class="bash">mv &quot;$f&quot; &quot;$f&quot;_temp
cp -r &quot;$src&quot; &quot;$f&quot;
rm -f &quot;$f&quot;_temp
echo -e &quot;$GREEN&quot;&quot;Copied&quot; $src
</pre>

	<p>Muuttuu seuraavaksi:</p>

<pre class="bash">mv &quot;$f&quot; &quot;$f&quot;_temp
$CMD &quot;$src&quot; &quot;$f&quot;
rm -f &quot;$f&quot;_temp
echo -e &quot;$GREEN$ACT&quot; $src
</pre>

	<p>Muuttujat tietenkin esitellään ohjelman alussa oletusarvoiksi. Sitten getopt-mehua koneistoon. Ensin kopioidaan tarvittava while-silmukka ja muistetaan se shift-komento myös. Sitten on hyvä kirjoittaa kommenteiksi se summariikki halutuista argumenteista, ettei unohdu. Lopputulos näyttää tältä:</p>

<pre class="bash"># arguments:
# -d    dry run: don&#39;t actually copy
# -m    move instead of copy
# -h    usage
while getopts &quot;:dmh&quot; flag
do
    case &quot;$flag&quot; in
        d)  DRYRUN=true ;;
        m)  CMD=&quot;mv&quot;
            ACT=&quot;Moved&quot; ;;
        h)  usage ;;
    esac
done
shift $((OPTIND-1))
</pre>

	<p>Sisäänrakennettu <code>getopts</code> ottaa vastaan merkkijonon, jossa on kaikki ohjeet, joiden mukaan se parsii syötteitä. Nyt meillä ei ole mitään kummempia juttuja. Kaksoispiste alussa tarkoittaa, ettei getoptsin tarvitse antaa virhettä, jos käyttäjä antaa vääriä parametrejä. Funktio <code>usage</code> on tyypillinen ohjeentulostaja:</p>

<pre class="bash">usage() {
    echo &quot;Usage: `basename $0` [options] file(s)&quot;
    echo &quot; -d    dry run: don&#39;t actually copy&quot;
    echo &quot; -m    move instead of copy&quot;
    echo &quot; -h    usage&quot;
    exit
}

# See if there is no arguments
if [ &quot;$#&quot; -eq &quot;0&quot; ] ; then
    usage
fi
</pre>

	<p>Kuten huomaat, meidän pitää lisäksi tehdä lisätyötä getoptsin lisäksi. Jos emme saa yhtään parametrejä niin on sama tulostaa käyttöohje.</p>

	<p>Ja, siinäpä se oikeastaan on. Mitään muita muutoksia ei ole. Testailuissani näyttää toimivan hyvin. Lopullinen tuotos kokonaisuudessaan. Ai niin, tietysti koeajoa varten piti lisätä vähän logiikkaa silmukkaan, mutta muilta osin. Kokonainen tuotos seuraa:</p>

<pre class="bash">#!/bin/bash
# realizes symbolic links into their flesh-and-blood counterparts

RED=&#39;\e[0;31m&#39;
GREEN=&#39;\e[0;32m&#39;

# defaults
CMD=&quot;cp -r&quot;
ACT=&quot;Copied&quot;

DRYRUN=false

usage() {
    echo &quot;Usage: `basename $0` [options] file(s)&quot;
    echo &quot; -d    dry run: don&#39;t actually copy&quot;
    echo &quot; -m    move instead of copy&quot;
    echo &quot; -h    usage&quot;
    exit
}

# See if there is no arguments
if [ &quot;$#&quot; -eq &quot;0&quot; ] ; then
    usage
fi

# arguments:
# -d    dry run: don&#39;t actually copy
# -m    move instead of copy
# -h    usage
while getopts &quot;:dmh&quot; flag
do
    case &quot;$flag&quot; in
        d)  DRYRUN=true ;;
        m)  CMD=&quot;mv&quot;
            ACT=&quot;Moved&quot; ;;
        h)  usage ;;
    esac
done
shift $((OPTIND-1))

for f in &quot;$@&quot;
do
    # test for symbolic
    if [ -h &quot;$f&quot; ]; then
        src=`readlink -n &quot;$f&quot;`
        if [ ! -e &quot;$src&quot; ]; then
            echo -e &quot;$RED&quot;&quot;Broken symlink: &quot; $f
            continue
        fi
        if $DRYRUN ; then
            echo &quot;[Dry run]&quot; $CMD &quot;$src&quot; &quot;$f&quot;
        else
            mv &quot;$f&quot; &quot;$f&quot;_temp
            $CMD &quot;$src&quot; &quot;$f&quot;
            rm -f &quot;$f&quot;_temp
            echo -e &quot;$GREEN$ACT&quot; $src
        fi
    fi
done
</pre>
</div>

<p class="tags"> 


Tageja: <a href="../../tag/bash/index.html" rel="tag">bash</a>, 
<a href="../../tag/gentoo/index.html" rel="tag">gentoo</a>, 
<a href="../../tag/ohjelmointi/index.html" rel="tag">ohjelmointi</a>


</p>



<div class="divider"><img src="../../images/1.gif" alt="---" width="400" height="1" /></div>


        </div>

 <!-- now, common stuff -->

        <div class="divider"><img src="../../images/1.gif" alt="---" width="400" height="1" /></div>

        <p><a rel="prev" href="../521/debian-ei-miellyta" title="Debian ei miellytä">&#171; Debian ei miellytä</a> 
           &mdash; <a rel="next" href="../523/kayttojarjestelmat-ja-miksi-linux" title="Käyttöjärjestelmät ja miksi Linux?">Käyttöjärjestelmät ja miksi Linux? &#187;</a>
        </p>

        <div class="divider"><img src="../../images/1.gif" alt="---" width="400" height="1" /></div>
        <h2>Aiheen vierestä</h2>
        <ul class="directory">

<li><span class="entry-title"><a rel="bookmark" href="../590/think-vimorganizer">Think&#160;VimOrganizer.</a></span> &#183; <span class="published">2012-09-02</span>
<br /><span class="smallexcerpt">Asiat rullaavat eteenpäin tyydyttävää tahtia tämän uuden tiedonhallinnan kanssa. Nyt olen säätänyt kuntoon jokaisesta kulmasta toimivan org-capture -variantin, jolla saan...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../587/tehokkaat-kayttoliittymat-vaivatta">Tehokkaat käyttöliittymät&#160;vaivatta</a></span> &#183; <span class="published">2012-08-16</span>
<br /><span class="smallexcerpt">Ohjelmoijan onni on elää komentorivillä. Tehokkaiden käyttöliittymien rustaaminen on varsin nopeata, kunhan luottaa siihen, että suurta suosiota tuotokset eivät tule...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../584/pythonin-vastaisku-lispeille-ipython-ja-vim-ipython">Pythonin vastaisku lispeille: IPython ja vim-ipython</a></span> &#183; <span class="published">2012-07-25</span>
<br /><span class="smallexcerpt">Tai &#8220;Pythonin uusi toivo&#8221; tai &#8220;Pythonin paluu&#8221;. Mistä on kyse? Pythonin tulkin me kaikki kai tiedämme: kaikki siinä periaatteessa on,...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../581/sumitup-puutteet-ja-mihin-suuntaan-edetaan">SumItUp: puutteet ja mihin suuntaan&#160;edetään</a></span> &#183; <span class="published">2012-07-12</span>
<br /><span class="smallexcerpt">Esittelin pari postausta sitten Soulver-kloonin raakileen, SumItUpin. Nyt se on GitHubissa kaikkien pällisteltävänä ja sellaisella raakileasteella, jotta sitä voi jo...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../579/soulver-kloonia-rakentelemassa">Soulver-kloonia&#160;rakentelemassa</a></span> &#183; <span class="published">2012-07-07</span>
<br /><span class="smallexcerpt">Erittäin upealla konseptilla varustettu laskinohjelma Soulver kaatuu siihen, että sen saa vain Mäkille. Vapaamuotoinen näpertelyalusta on usein ainut asia, mitä...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../571/tv-saato-on-nyt-valmis">TV-säätö on nyt&#160;valmis</a></span> &#183; <span class="published">2012-03-23</span>
<br /><span class="smallexcerpt">No niin. Uuden NVidia-kortin ansiosta TV-episodi on käsitelty voitokkaasti. Jos rahalla asiasta selviämistä ei lasketa huijaamiseksi.

	Oppirahoja tuli taas tosiaankin hassattua....</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../569/satunnaiset-jazzit-soittolistalta">Satunnaiset jazzit&#160;soittolistalta</a></span> &#183; <span class="published">2012-03-18</span>
<br /><span class="smallexcerpt">Jonkin aikaa sitten kirjailin nopean bash-skriptin, joka hakee haluamastaan MPD-soittolistasta tietyn verran kappaleita. Siten, että musiikkia saadaan noin tietyn aikarajan...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../568/avoimet-suljetut-ja-se-vastapuoli">Avoimet, suljetut ja se&#160;vastapuoli</a></span> &#183; <span class="published">2012-03-11</span>
<br /><span class="smallexcerpt">Radeonien kanssa on todellakin painittavaa. Kompromisseista on jotain valittava kontolleen, jos muut sitten sujuvatkin.

	fglrx &#8212; se suljettu

	Kaikki työpöytäkäyttö sujuu erihyvin....</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../567/tv-monitorit-ja-gentoo">TV, Monitorit ja&#160;Gentoo</a></span> &#183; <span class="published">2012-03-09</span>
<br /><span class="smallexcerpt">Pari viikkoa sitten sain lahjaksi taulu-TV:n (Philipsin 42FPL3606, eli 42 tuumaa) ja totta kai se pitää saada kiinni tietokoneeseen pikselitarkalla...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../566/terminaaleja-vimista-kasin">Terminaaleja Vimistä&#160;käsin</a></span> &#183; <span class="published">2012-02-11</span>
<br /><span class="smallexcerpt">Vanha kunnon ConqueTerm on nyt valmis ja käyttökelpoinen tuote kehittelyyn.

	Olen viime päivinä alkanut käyttää vimiä hyvin emacsmaisesti. Se on tietenkin...</span>
</li>

</ul>

    </div>


<!-- footer -->
	<div id="foot">&nbsp;</div>

</div>

</body>
</html>
