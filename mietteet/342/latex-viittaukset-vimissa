<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />


        <!-- standard -->
	<title>Mr. P: LaTeX-viittaukset Vimissä</title>


	<link rel="home" href="../../index.html" />

	<link rel="alternate" type="application/atom+xml" title="Atom 1.0" href="../../atom/index.html?section=mietteet" />
	<link rel="alternate" type="application/rss+xml" title="RSS 0.92" href="../../rss/index.html?section=mietteet" />

	<link rel="stylesheet" type="text/css" media="screen" href="../../blog.css" />
        <link rel="stylesheet" type="text/css" href="../../codeblock.css" />

            <!-- SyntaxHighlighter: http://alexgorbatchev.com -->
    <script type="text/javascript" src="../../scripts/xregexp-min.js"></script>
    <script type="text/javascript" src="../../scripts/shCore.js"></script>
    <!-- langs -->
    <script type="text/javascript" src="../../scripts/shBrushBash.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushCpp.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushPhp.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushPerl.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushPython.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushClojure.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushJava.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushHaskell.js"></script>
    <script type="text/javascript" src="../../scripts/shBrushVimscript.js"></script>
    <script type="text/javascript">
        SyntaxHighlighter.all();
    </script>

	<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../rpc/index.html" />
</head>

<body id="mietteet">

<!-- accessibility -->
<div id="accessibility">
    <ul>
        <li><a href="latex-viittaukset-vimissa#content">Siirry sisältöön</a></li>
        <li><a href="latex-viittaukset-vimissa#sidebar-2">Siirry hakuun</a></li>
    </ul>
</div>

<div id="container">

<!-- head -->
    <div id="head">
        <h1 id="site-name"><a rel="home" href="../../index.html">Mr. P</a></h1>
        <p id="site-slogan">Asiaa porjoilun tuolta puolen</p>
    </div>

<!-- right -->
    <div id="sidebar-2">
        <ul class="section_list">
	<li>
            
            <a href="../../hetket/index.html">Hetkessä</a>
            
        </li>
	<li>
            
            <a href="../../matematiikka/index.html">Matematiikka</a>
            
        </li>
	<li>
            &raquo;
            <a href="../index.html">Mietteet</a>
            
                <!--<ul>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/598/blogille-idea">Blogille&#160;idea</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/597/wes-mckinney-python-for-data-analysis-oreilly">Wes McKinney - Python For Data Analysis (O&#39;Reilly)</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/596/org-blogaaminen-vaikeata">Org-blogaaminen&#160;vaikeata</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/595/twitterointia-emacsilla">Twitteröintiä&#160;Emacsilla</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/594/weboodi-aikataulut-orgiin">WebOodi-aikataulut&#160;orgiin</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/593/emacsin-salat-alkavat-selvita-org-kovenee-ja-muita-tarinoita">Emacsin salat alkavat selvitä; org kovenee ja muita&#160;tarinoita</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/592/emacs-has-me">Emacs has&#160;me.</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/591/editorien-taistelu-tietamyshallinnassa">Editorien taistelu&#160;tietämyshallinnassa</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/590/think-vimorganizer">Think&#160;VimOrganizer.</a>
                </li>
	<li>
                    
                    <a rel="bookmark" href="/mietteet/589/think-orgmode">Think&#160;orgmode.</a>
                </li>
</ul>-->
            
        </li>
</ul>
<!--        <p class="sidebarhead">Aiheita:</p>
        <ul class="category_list">
	<li><a href="/kategoria/hifi/">Hifi</a></li>
	<li><a href="/kategoria/koodaus/">Ohjelmointi</a></li>
	<li><a href="/kategoria/ohjelmistot/">Ohjelmistot</a></li>
	<li><a href="/kategoria/Opiskelu/">Opiskelu</a></li>
	<li><a href="/kategoria/rauta/">Rauta</a></li>
	<li><a href="/kategoria/viihde/">Viihde</a></li>
	<li><a href="/kategoria/Yleistae-turinaa/">Yleistä turinaa</a></li>
</ul> -->

        <p class="sidebarhead">Valikoituja aiheita:</p>
        <ul class="category_list">
	<li><a href="../../tag/blogisäätöä/index.html" class="tagSizeMedium tagSize25" style="font-size: 100%;">blogisäätöä</a></li>
	<li><a href="../../tag/clojure/index.html" class="tagSizeSmallest tagSize1" style="font-size: 100%;">clojure</a></li>
	<li><a href="../../tag/gentoo/index.html" class="tagSizeLargest tagSize105" style="font-size: 100%;">gentoo</a></li>
	<li><a href="../../tag/hifi/index.html" class="tagSizeMedium tagSize31" style="font-size: 100%;">hifi</a></li>
	<li><a href="../../tag/musiikki/index.html" class="tagSizeMedium tagSize23" style="font-size: 100%;">musiikki</a></li>
	<li><a href="../../tag/ohjelmointi/index.html" class="tagSizeMedium tagSize42" style="font-size: 100%;">ohjelmointi</a></li>
	<li><a href="../../tag/ostoksia/index.html" class="tagSizeMedium tagSize11" style="font-size: 100%;">ostoksia</a></li>
	<li><a href="../../tag/vim/index.html" class="tagSizeMedium tagSize34" style="font-size: 100%;">vim</a></li>
</ul>
        <p><a href="../../tag/index.html">Kaikki tagit</a></p>

        <form method="get" action="../../index.html">
<p class="search_input">Hae<br /><input type="text" value="" name="q" size="15" /></p>
</form>

        <p><a href="../../rss/index.html?section=mietteet" title="RSS 0.92">RSS</a> / <a href="../../atom/index.html?section=mietteet" title="Atom 1.0">Atom</a></p>
        <p class="linklist"><a href="http://textpattern.net/">TextBook</a><br /><a href="http://textpattern.com/">Textpattern</a><br /><a href="http://textpattern.org/">Txp Resources</a><br /><a href="http://twitter.com/progo_" title="Twitter-profiilini">Twitter</a><br /></p>

        <p><a href="http://textpattern.com/"><img src="../../images/2.png" alt="Textpattern CMS" width="105" height="45" /></a></p>
    </div>


<!-- center -->
    <div id="content">



<!-- not tag view, it's the main view -->


        

        <div class="hfeed">
            <!-- five articles to list here, or only one. It depends. -->
            <!-- default form -->

<p class="published"> 9. lokakuu 2010, 20:03</p>
<h1 class="entry-title"><a rel="bookmark" href="latex-viittaukset-vimissa">LaTeX-viittaukset&#160;Vimissä</a></h1>


<div class="entry-content">
	<p>Kirjailin taas uuden palan korostamaan, miten hienosti saa Vimistä irti kaikenlaista. LaTeXissa ja TeXissä yleensäkin viittailessa omaan dokumenttiin halutaan yleensä käyttää komento <code>\label{nimiö}</code> ja sitten siihen voidaan viitata komennolla <code>\ref{nimiö}</code>. Tämä yleensä palauttaa numeroidun otsikon, listan kohdan tai jonkun muun juoksevan numeron. <span class="caps">PDF</span>-LaTeX vielä lisää hyperlinkin. Lisäksi on <code>\pageref{nimiö}</code>, joka antaa suoran sivunumeron sille sivulle, missä annettu <code>\label</code> sijaitsee.</p>

	<p>Eli idea on kiva. Systeemiä kannattaa isoissa dokumenteissa hieman vielä parantaa siten, että erityyppisiin kohteisiin viittaavat labelit nimetään systemaattisesti, esimerkiksi omissa töissäni:</p>

	<ul>
		<li><code>sec:</code> -etuliite otsikoille (<em>section</em>)</li>
		<li><code>fig:</code>  kuville (<em>figures</em>)</li>
		<li><code>tab:</code>  taulukoille (<em>tables</em>, <em>tabular</em>)</li>
		<li><code>eq:</code> lausekkeille</li>
	</ul>

	<p>Semanttisuuden nimissä jaottelua saa toki jatkaa mielinmäärin, eikä nimiöiden nimeämisessä ole juurikaan rajoitteita. </p>

	<p>Mutta sitten ongelmana on, että nimiöitä voi olla aika paljon, ja niiden yksikäsitteinen nimeäminen vaatii vähän vaivaa, ja kaikkien muistaminen on hankalaa. Olisipa se poikaa antaa Vimin hoitaa muistamiset puolestani. Käyttäjän kontolle jää hyvien, kuvaavien nimiöiden keksiminen. Pituudella ei ole enää väliä, koska vimin automaattitäydennys hoitaa homman kotiin vähillä näppäilyillä.</p>

	<h2>Toteutus</h2>

	<p>Ensin otetaan omnicompletion-funktioiden perusrunko esille:</p>

<pre class="vim">function! CompleteTeXLabels(findstart, base)
    &quot; findstart == 1 when this is called for the first time
    if a:findstart
        let line = getline(&#39;.&#39;)
        let start = col(&#39;.&#39;) - 1
        while start &gt; 0 &amp;&amp; line[start - 1] =~ &#39;\a&#39;
            let start -= 1
        endwhile
        return start
    else
        let labels = []
        &quot; haetaan sopivat nimiöt tässä kohtaa
        return labels
    endif
endfun
</pre>

	<p>Kullakin LaTeX-koodin rivillä voi olla nolla, yksi tai useampia <code>\label</code>-määrittelyjä. Laitetaan Vim matchaamaan jokaista riviä nimiöiden toivossa. Selkeyttääkseni olen kirjoittanut yksittäisen rivin tutkinnan omaksi metodikseen:</p>

<pre class="vim">fun! FindLabels(line) 
    let matches = []
    let i = 1
    let lm = matchlist(a:line, &#39;\v\\label\s*\{([^}]+)}{-1}&#39;)
    while !empty(lm)
        call add(matches, lm[1])
        let i += 1
        let lm = matchlist(a:line, &#39;\v\\label\s*\{([^}]+)}{-1}&#39;, 0, i)
    endwhile
    return matches
endfun
</pre>

	<p>Nyt ollaan nätisti asian ytimessä! Säännöllinen lauseke oli melko paskamainen saada kuntoon, sillä jostain syystä <code>\{(.+)\}{-1}</code> ei toimi, kuten luulisi. Vimin lausekkeissa miinusmerkkinen haku tarkoittaa, että matchaus loppuu ensimmäiseen löytyneeseen osumaan, siis non-greedyyn tapaan. Kuitenkin tämä jätti toimimatta (ottanen yhteyttä asian tiimoilta Vimin postilistoille) ja jouduin käyttämään kirjainluokkaa, joka rajaa }-merkit sisältä pois. Ei iso omissio, mutta kaipa LaTeXissa joku haluaisi käyttää labeleita tyyliin <code>\label{Nice and big\{not\}}</code>, joka ei enää toimisi skriptissäni.</p>

	<p>Muuten FindLabels toimii kuten odottaa saattaa. Varsinainen toiminnallisuus nyt ujutetaan tuonne <code>CompleteTeXLabels</code> -funktion sisään:</p>

<pre class="vim">let line = line(&#39;.&#39;)
while line &gt;= 0
    let laline = FindLabels(getline(line))
    let line -= 1
    for label in laline
        if label =~ &#39;^&#39; . a:base
            call add(labels, label)
        endif
    endfor
endwhile
</pre>

	<p>Tämä on ensimmäinen raakaversio toiminnallisuudesta. Se tekee yhden ison omission: labeleita haetaan vain kutsuriviltä ja taaksepäin, aina tiedoston alkuun. Eli jos teet uuden labelin tiedoston lopuille ja haluat reffin keskelle, ei tämä ensiversio toimi. Syynä on se, että aluksi olin skeptinen tämän kokonaisuuden suorituskyvystä. Melko raskasta parsia koko tiedostoa aina kun halutaan löytää nimiöitä. </p>

	<p>Kuitenkin havaitsin homman sulavaksi isoillakin tiedostoilla, 4000-rivisilläkin. Jos lisään nyt ketjuun toisen puoliskon, saadaan ainakin senhetkinen bufferi katettua. Sopivalla tavalla järjestelemällä haut saadaan aikaan systeemi, missä ensimmäisenä täydennyslistalla ovat nimiöt ylöspäin ja sitten nimiöt alaspäin. Koodiin lisätään siis toinen silmukka, aika- tai tilavaativuus ei kasva.</p>

<pre class="vim">        &quot; forwards
        let line = line(&#39;.&#39;) + 1
        let eol = line(&#39;$&#39;) 
        while line &lt;= eol
            let laline = FindLabels(getline(line))
            let line += 1
            for label in laline
                if label =~ &#39;^&#39; . a:base
                    call add(labels, label)
                endif
            endfor
        endwhile
</pre>

	<p>Ongelmana on kuitenkin se, että isommat LaTeX-tarinoinnit kannattaa hallinnollisista syistä jakaa useisiin tiedostoihin. Toteutuksen voisi tehdä siten, että haku tehdään kaikista aukiolevista tex-päätteellisistä tiedostoista. Niin, niin sen voisi tehdä.</p>

	<p>Sitä varten taitaa kannattaa tehdä jo taas jakoa useampaan funktioon. Lopulta varsinainen omnifunktio koostuu seuraavanlaisesta lihasta:</p>

<pre class="vim">        let labels = []
        &quot; go through all buffers
        for bufnum in range(1, bufnr(&#39;$&#39;))
            if bufname(bufnum) =~ &quot;\.tex$&quot;
                let labels +=  FindLabels_Buffer(bufnum, a:base)
            endif
        endfor
        return labels
</pre>

	<p>Tässä koodissa <code>FindLabels_Buffer</code> tekee laajalti osin saman, mitä aiemmissa, yhtä bufferia koskevissa toteutuksissa tehdään. Siitä toteutuksesta tuli varsin sotkuinen, joten toistaiseksi jätän sen toteutuksen harjoitustehtäväksi. ;) Se kuitenkin sotkuisuudessaan toteuttaa alkuperäisen idean, että aktiivisen bufferin sisältöä käydään ensin kutsuriviltä ylöspäin, sitten alaspäin, ja sitten muut puskurit rivijärjestyksessä. En äkkiseltään löytänyt suoraa ratkaisua sille, miten haetaan tietyn puskurin rivimäärä, joten jouduin käyttämään potentiaalisesti kallista metodia, joka palauttaa koko puskurin rivit listana. Hyvässä tapauksessa se on kytketty suoraan Vimin sisäiseen tiedostototeutukseen, huonossa tapauksessa jokainen puskuri kopioidaan muistiin toista kertaa, hitaasti. </p>

	<p>Toteutus on edelleen (!) nopea, vaikka alunperin ajattelin jonkun cachetuksen järjestää. Ei tunnukaan olevan tarvetta. </p>
</div>

<p class="tags"> 


Tageja: <a href="../../tag/latex/index.html" rel="tag">latex</a>, 
<a href="../../tag/ohjelmointi/index.html" rel="tag">ohjelmointi</a>, 
<a href="../../tag/vim/index.html" rel="tag">vim</a>


</p>



<div class="divider"><img src="../../images/1.gif" alt="---" width="400" height="1" /></div>


        </div>

 <!-- now, common stuff -->

        <div class="divider"><img src="../../images/1.gif" alt="---" width="400" height="1" /></div>

        <p><a rel="prev" href="../340/rainlendar-pitaa-paikkansa" title="Rainlendar pitää paikkansa">&#171; Rainlendar pitää paikkansa</a> 
           &mdash; <a rel="next" href="../343/bloggaus-ohjelmointi" title="Bloggaus-ohjelmointi?">Bloggaus-ohjelmointi? &#187;</a>
        </p>

        <div class="divider"><img src="../../images/1.gif" alt="---" width="400" height="1" /></div>
        <h2>Aiheen vierestä</h2>
        <ul class="directory">

<li><span class="entry-title"><a rel="bookmark" href="../594/weboodi-aikataulut-orgiin">WebOodi-aikataulut&#160;orgiin</a></span> &#183; <span class="published">2012-10-23</span>
<br /><span class="smallexcerpt">Itä-Suomen yliopiston weboodissa alkaa olla aika usein kurssi-infot hyvässä kunnossa, ja nyt on myös joensuulaisille olemassa tuota lukkaria, joka on...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../593/emacsin-salat-alkavat-selvita-org-kovenee-ja-muita-tarinoita">Emacsin salat alkavat selvitä; org kovenee ja muita&#160;tarinoita</a></span> &#183; <span class="published">2012-10-17</span>
<br /><span class="smallexcerpt">Tässä on ihmetelty jo hyvän aikaa uusissa maailmoissa, ja pitkälle on päästy. En olisi itsestäni uskonut, että Emacsissa ollaan jonain...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../592/emacs-has-me">Emacs has&#160;me.</a></span> &#183; <span class="published">2012-09-22</span>
<br /><span class="smallexcerpt">Emacs alkaa ottaa otetta minusta. Olen yrittänyt olla pyristelemättä vastaan, eikä ole asiaa vastaan mitään sanottavaa. Kaikki ne herkut ja...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../591/editorien-taistelu-tietamyshallinnassa">Editorien taistelu&#160;tietämyshallinnassa</a></span> &#183; <span class="published">2012-09-14</span>
<br /><span class="smallexcerpt">Kun päädyin pari viikkoa sitten Org-formaattiin, oli se luonnollisesti edellytys, että Vim ja sen VimOrganizer saadaan kuntoon. Nyt kuitenkin on...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../590/think-vimorganizer">Think&#160;VimOrganizer.</a></span> &#183; <span class="published">2012-09-02</span>
<br /><span class="smallexcerpt">Asiat rullaavat eteenpäin tyydyttävää tahtia tämän uuden tiedonhallinnan kanssa. Nyt olen säätänyt kuntoon jokaisesta kulmasta toimivan org-capture -variantin, jolla saan...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../589/think-orgmode">Think&#160;orgmode.</a></span> &#183; <span class="published">2012-08-31</span>
<br /><span class="smallexcerpt">Teemme taas täyden ympyrän palatessamme orgmodeen, tuohon viha-rakkaussuhteen saaneeseen pakettiin. Edellinen thinktank-idea lopulta vääntyy siihen, että voin joko tehdä simppelin...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../587/tehokkaat-kayttoliittymat-vaivatta">Tehokkaat käyttöliittymät&#160;vaivatta</a></span> &#183; <span class="published">2012-08-16</span>
<br /><span class="smallexcerpt">Ohjelmoijan onni on elää komentorivillä. Tehokkaiden käyttöliittymien rustaaminen on varsin nopeata, kunhan luottaa siihen, että suurta suosiota tuotokset eivät tule...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../584/pythonin-vastaisku-lispeille-ipython-ja-vim-ipython">Pythonin vastaisku lispeille: IPython ja vim-ipython</a></span> &#183; <span class="published">2012-07-25</span>
<br /><span class="smallexcerpt">Tai &#8220;Pythonin uusi toivo&#8221; tai &#8220;Pythonin paluu&#8221;. Mistä on kyse? Pythonin tulkin me kaikki kai tiedämme: kaikki siinä periaatteessa on,...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../581/sumitup-puutteet-ja-mihin-suuntaan-edetaan">SumItUp: puutteet ja mihin suuntaan&#160;edetään</a></span> &#183; <span class="published">2012-07-12</span>
<br /><span class="smallexcerpt">Esittelin pari postausta sitten Soulver-kloonin raakileen, SumItUpin. Nyt se on GitHubissa kaikkien pällisteltävänä ja sellaisella raakileasteella, jotta sitä voi jo...</span>
</li>



<li><span class="entry-title"><a rel="bookmark" href="../579/soulver-kloonia-rakentelemassa">Soulver-kloonia&#160;rakentelemassa</a></span> &#183; <span class="published">2012-07-07</span>
<br /><span class="smallexcerpt">Erittäin upealla konseptilla varustettu laskinohjelma Soulver kaatuu siihen, että sen saa vain Mäkille. Vapaamuotoinen näpertelyalusta on usein ainut asia, mitä...</span>
</li>

</ul>

    </div>


<!-- footer -->
	<div id="foot">&nbsp;</div>

</div>

</body>
</html>
